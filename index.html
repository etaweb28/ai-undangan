<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>The Wedding Of</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Poppins:wght@300;400;500&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
:root{
  --gold:#c9a24d;
  --cream:#f7f3ea;
  --dark:#333;
  --white:#fff;
}
*{box-sizing:border-box}
html{scroll-behavior:smooth}
body{
  margin:0;
  font-family:'Poppins',sans-serif;
  background:var(--cream);
  color:var(--dark);
}

/* LOADER */
#loader{
  position:fixed;inset:0;
  background:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#loader span{
  font-family:'Playfair Display',serif;
  font-size:26px;
  color:var(--gold);
  animation:pulse 1.5s infinite;
}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:1}}

/* HERO COVER */
.hero{
  min-height:100vh;
  background:
    linear-gradient(rgba(0,0,0,.50),rgba(0,0,0,.50)),
    url('https://images.unsplash.com/photo-1523438885200-e635ba2c371e?auto=format&fit=crop&w=1200&q=80');
  background-size:cover;
  background-position:center;
  color:#fff;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  padding:30px;
  position:relative;
}
.hero h1{
  font-family:'Playfair Display',serif;
  font-size:38px;
  margin:10px 0;
}
.hero .small{letter-spacing:3px;font-size:13px}
.hero .date{opacity:.9}
.hero .btn{
  margin-top:18px;
  padding:14px 30px;
  border-radius:40px;
  border:none;
  background:var(--gold);
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
.hero .btn.secondary{
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.25);
}
.hero .stack{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}

/* PANEL FORM (bottom sheet style) */
.sheet{
  position:fixed;
  left:0;right:0;bottom:0;
  background:rgba(255,255,255,.96);
  backdrop-filter: blur(8px);
  border-top-left-radius:18px;
  border-top-right-radius:18px;
  box-shadow:0 -16px 40px rgba(0,0,0,.15);
  padding:16px 16px 18px;
  transform:translateY(110%);
  transition:transform .35s ease;
  z-index:999;
  max-height:78vh;
  overflow:auto;
}
.sheet.open{transform:translateY(0)}
.sheet h3{
  font-family:'Playfair Display',serif;
  margin:6px 0 10px;
  color:var(--gold);
  text-align:center;
}
.sheet .row{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
}
.sheet .row3{
  display:grid;
  grid-template-columns:1fr 1fr 1fr;
  gap:10px;
}
.sheet label{font-size:12px;color:#555}
.sheet input, .sheet textarea, .sheet select{
  width:100%;
  padding:11px 12px;
  border-radius:12px;
  border:1px solid #e6e1d6;
  font-size:14px;
  outline:none;
  background:#fff;
}
.sheet textarea{min-height:100px;resize:none}
.sheet .actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}
.sheet button{
  flex:1;
  padding:13px 14px;
  border-radius:14px;
  border:none;
  cursor:pointer;
  font-weight:600;
}
.sheet .primary{background:var(--gold);color:#fff}
.sheet .ghost{background:#fff;border:1px solid #e6e1d6}
.sheet .hint{font-size:12px;color:#666;margin-top:10px;text-align:center}

/* SECTIONS */
section{padding:58px 18px;max-width:1100px;margin:auto}
h2{
  font-family:'Playfair Display',serif;
  text-align:center;
  color:var(--gold);
  margin-bottom:28px;
}
.card{
  background:#fff;
  border-radius:18px;
  padding:20px;
  box-shadow:0 12px 30px rgba(0,0,0,.08);
}
.fade{
  opacity:0;
  transform:translateY(18px);
  transition:all .8s ease;
}
.fade.show{opacity:1;transform:translateY(0)}

/* Couple */
.couple{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:22px;
}
.person{text-align:center}
.person img{
  width:170px;height:170px;
  border-radius:50%;
  border:5px solid var(--gold);
  object-fit:cover;
  background:#f0ebe0;
}
.person h3{margin:12px 0 4px;font-family:'Playfair Display',serif}
.person p{margin:0;color:#666;font-size:13px}

/* Event */
.event{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
}
.event .card i{font-size:26px;color:var(--gold);margin-bottom:8px}

/* Countdown */
.countdown{display:flex;justify-content:center;gap:12px;flex-wrap:wrap}
.time{
  background:#fff;width:82px;
  padding:14px 10px;border-radius:16px;text-align:center;
  box-shadow:0 10px 24px rgba(0,0,0,.06);
}
.time span{display:block;font-size:22px;font-weight:700;color:var(--gold)}

/* Gallery */
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:12px;
}
.gallery img{
  width:100%;
  border-radius:14px;
  cursor:pointer;
  object-fit:cover;
  height:160px;
  background:#f0ebe0;
}
#lightbox{
  position:fixed;inset:0;
  background:rgba(0,0,0,.82);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  padding:22px;
}
#lightbox img{
  max-width:95%;
  max-height:90vh;
  border-radius:16px;
}

/* Map */
iframe{width:100%;height:320px;border:0;border-radius:16px}
.map-actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
.map-actions a, .map-actions button{
  flex:1;
  min-width:180px;
  text-align:center;
  padding:12px 14px;
  border-radius:14px;
  border:none;
  background:var(--gold);
  color:#fff;
  text-decoration:none;
  cursor:pointer;
  font-weight:600;
}
.map-actions .ghost{
  background:#fff;color:var(--gold);border:1px solid #e6e1d6;
}

/* Guestbook dummy */
form{max-width:520px;margin:auto}
form input, form textarea, form select{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:1px solid #e6e1d6;
  margin-top:10px;
  background:#fff;
}
form button{
  width:100%;
  margin-top:12px;
  background:var(--gold);
  border:none;
  color:#fff;
  padding:14px;
  border-radius:30px;
  font-weight:700;
}
#guestPreview{margin-top:16px}
.gItem{
  background:#fff;
  border:1px solid #eee4d4;
  padding:12px;
  border-radius:14px;
  margin-top:10px;
}

/* Footer */
footer{
  text-align:center;
  padding:46px 18px;
  font-family:'Playfair Display',serif;
}
footer i{color:#e85b81}

/* Music Floating Button */
.music-btn{
  position:fixed;
  bottom:20px;
  right:20px;
  width:56px;height:56px;
  border-radius:50%;
  background:var(--gold);
  color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-size:22px;
  cursor:pointer;
  box-shadow:0 10px 26px rgba(0,0,0,.25);
  z-index:998;
}

/* Share link toast */
.toast{
  position:fixed;
  left:50%;
  bottom:92px;
  transform:translateX(-50%);
  background:rgba(0,0,0,.78);
  color:#fff;
  padding:10px 14px;
  border-radius:14px;
  font-size:13px;
  display:none;
  z-index:1001;
}

@media(max-width:820px){
  .couple,.event{grid-template-columns:1fr}
  .hero h1{font-size:30px}
  .sheet .row, .sheet .row3{grid-template-columns:1fr}
}
</style>
</head>

<body>

<div id="loader"><span>The Wedding</span></div>

<!-- HERO -->
<section class="hero" id="top">
  <div>
    <div class="small">THE WEDDING OF</div>
    <h1 id="heroNames">(Namamu) & (Nama Pasanganmu)</h1>
    <p class="date" id="heroDate">Tanggal Acara</p>

    <div class="stack">
      <button class="btn" id="btnOpen" onclick="openInvitation()">Buka Undangan</button>
      <button class="btn secondary" onclick="openSheet()"><i class="fa-solid fa-wand-magic-sparkles"></i> Buat dengan AI</button>
    </div>

    <p style="margin-top:14px;font-size:12px;opacity:.85">
      *Musik akan mulai setelah klik ‚ÄúBuka Undangan‚Äù
    </p>
  </div>
</section>

<!-- SHEET FORM -->
<div class="sheet" id="sheet">
  <h3>AI Pembuat Undangan</h3>

  <label>Prompt (tulis bebas)</label>
  <textarea id="prompt" placeholder="Contoh: Pernikahan modern elegan di Bandung, akad pagi resepsi siang, lokasi Gedung Serbaguna..."></textarea>

  <div class="row">
    <div>
      <label>Nama Pria (opsional)</label>
      <input id="groomOverride" placeholder="Contoh: Andi">
    </div>
    <div>
      <label>Nama Wanita (opsional)</label>
      <input id="brideOverride" placeholder="Contoh: Sinta">
    </div>
  </div>

  <div class="row3">
    <div>
      <label>Tanggal (opsional)</label>
      <input id="dateOverride" placeholder="Contoh: 20 Juli 2026">
    </div>
    <div>
      <label>Akad (opsional)</label>
      <input id="akadOverride" placeholder="Contoh: 09.00 WIB">
    </div>
    <div>
      <label>Resepsi (opsional)</label>
      <input id="resepsiOverride" placeholder="Contoh: 11.00 WIB">
    </div>
  </div>

  <div class="row">
    <div>
      <label>Lokasi / Venue (opsional)</label>
      <input id="venueOverride" placeholder="Contoh: Gedung Serbaguna BSD">
    </div>
    <div>
      <label>Alamat / Maps Query (opsional)</label>
      <input id="mapsOverride" placeholder="Contoh: Jl. Sudirman No. 10, Bandung">
    </div>
  </div>

  <label>Pilih Lagu</label>
  <select id="musicSelect">
    <option value="wedding1.mp3">üéµ You're Still The One ‚Äì Shania Twain</option>
    <option value="wedding2.mp3">üéµ Pilihanku ‚Äì MALIQ & D'Essentials</option>
    <option value="wedding3.mp3">üéµ Beautiful In White ‚Äì Shane Filan</option>
  </select>

  <div class="row">
    <div>
      <label>Foto Mempelai Pria</label>
      <input type="file" id="groomPhoto" accept="image/*">
    </div>
    <div>
      <label>Foto Mempelai Wanita</label>
      <input type="file" id="bridePhoto" accept="image/*">
    </div>
  </div>

  <label>Galeri (maks 10 foto)</label>
  <input type="file" id="galleryPhotos" accept="image/*" multiple>

  <div class="actions">
    <button class="ghost" onclick="closeSheet()">Tutup</button>
    <button class="primary" onclick="generateAndPreview()"><i class="fa-solid fa-wand-magic-sparkles"></i> Generate</button>
  </div>
  <div class="actions">
    <button class="ghost" onclick="copyPreviewText()">Copy Teks</button>
    <button class="primary" onclick="saveToKVAndMakeLink()"><i class="fa-solid fa-link"></i> Simpan & Buat Link</button>
  </div>

  <div class="hint" id="sheetHint">Hasil AI akan langsung mengisi halaman ini.</div>
</div>

<!-- CONTENT -->
<section id="content">

  <!-- PASANGAN -->
  <h2 class="fade">Pasangan</h2>
  <div class="couple fade">
    <div class="person card">
      <img id="groomImg" src="https://via.placeholder.com/600x600?text=Foto+(Namamu)" alt="Foto mempelai pria">
      <h3 id="groomName">(Namamu)</h3>
      <p id="groomParents">Putra dari Bapak ... & Ibu ...</p>
    </div>
    <div class="person card">
      <img id="brideImg" src="https://via.placeholder.com/600x600?text=Foto+(Nama+Pasanganmu)" alt="Foto mempelai wanita">
      <h3 id="brideName">(Nama Pasanganmu)</h3>
      <p id="brideParents">Putri dari Bapak ... & Ibu ...</p>
    </div>
  </div>

  <p class="fade" style="text-align:center;margin-top:26px;font-style:italic">
    "Dan di antara tanda-tanda kekuasaan-Nya ialah Dia menciptakan pasangan-pasangan..."<br>
    <strong>(QS. Ar-Rum: 21)</strong>
  </p>

  <!-- EVENT -->
  <section>
    <h2 class="fade">Detail Acara</h2>
    <div class="event fade">
      <div class="card">
        <i class="fa-solid fa-mosque"></i>
        <h3>Akad Nikah</h3>
        <p id="akadInfo">Tanggal ‚Ä¢ Jam ‚Ä¢ Lokasi</p>
      </div>
      <div class="card">
        <i class="fa-solid fa-champagne-glasses"></i>
        <h3>Resepsi</h3>
        <p id="resepsiInfo">Tanggal ‚Ä¢ Jam ‚Ä¢ Lokasi</p>
      </div>
    </div>
  </section>

  <!-- COUNTDOWN -->
  <section>
    <h2 class="fade">Hitung Mundur</h2>
    <div class="countdown fade">
      <div class="time"><span id="d">0</span>Hari</div>
      <div class="time"><span id="h">0</span>Jam</div>
      <div class="time"><span id="m">0</span>Menit</div>
      <div class="time"><span id="s">0</span>Detik</div>
    </div>
    <p class="fade" style="text-align:center;font-size:12px;color:#777;margin-top:12px" id="countHint">
      *Countdown akan menyesuaikan jika tanggal berhasil terbaca.
    </p>
  </section>

  <!-- GALLERY -->
  <section>
    <h2 class="fade">Galeri Foto</h2>
    <div class="gallery fade" id="gallery">
      <img src="https://picsum.photos/500?1" alt="Gallery 1">
      <img src="https://picsum.photos/500?2" alt="Gallery 2">
      <img src="https://picsum.photos/500?3" alt="Gallery 3">
    </div>
  </section>

  <!-- LOCATION -->
  <section>
    <h2 class="fade">Lokasi</h2>
    <div class="card fade">
      <div id="locText" style="font-size:14px;color:#666">üìç Lokasi acara</div>
      <iframe id="map" src="https://www.google.com/maps?q=Indonesia&output=embed" loading="lazy"></iframe>
      <div class="map-actions">
        <a id="openMapsBtn" href="https://www.google.com/maps?q=Indonesia" target="_blank">
          <i class="fa-solid fa-location-dot"></i> Buka di Google Maps
        </a>
        <button class="ghost" onclick="shareLink()">
          <i class="fa-solid fa-share-nodes"></i> Share Link
        </button>
      </div>
    </div>
  </section>

  <!-- GUESTBOOK DUMMY -->
  <section>
    <h2 class="fade">Buku Tamu</h2>
    <div class="card fade">
      <form id="guestForm">
        <input id="guestName" placeholder="Nama">
        <textarea id="guestMsg" placeholder="Pesan" rows="3"></textarea>
        <select id="guestAttend">
          <option value="Hadir">Hadir</option>
          <option value="Tidak Hadir">Tidak Hadir</option>
        </select>
        <button type="submit"><i class="fa-solid fa-paper-plane"></i> Kirim</button>
      </form>
      <div id="guestPreview"></div>
      <p style="font-size:12px;color:#777;text-align:center;margin-top:12px">
        *Dummy frontend (tanpa backend). Bisa di-upgrade ke KV nanti.
      </p>
    </div>
  </section>

  <!-- CLOSING -->
  <footer class="fade">
    Terima kasih atas doa & restunya<br>
    <strong id="footerNames">(Namamu) & (Nama Pasanganmu)</strong><br><br>
    <i class="fa-solid fa-heart"></i>
  </footer>

</section>

<!-- LIGHTBOX -->
<div id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg" alt="Preview">
</div>

<!-- MUSIC -->
<audio id="music" loop>
  <source id="musicSource" src="wedding1.mp3" type="audio/mpeg">
</audio>
<div class="music-btn" onclick="toggleMusic()" title="Music">
  <i class="fa-solid fa-music"></i>
</div>

<div class="toast" id="toast">Link disalin ‚úÖ</div>

<script>
/* =============================
   CONFIG
============================= */
const API = "https://dry-mud-3b8ai-undangan-api.etaweb90.workers.dev";
let currentInvite = null;
let currentMusic = "wedding1.mp3";

/* =============================
   INIT (loader + reveal)
============================= */
window.addEventListener("load", () => {
  setTimeout(() => loader.style.display = "none", 800);
  initReveal();
  initGuestbookDummy();
  initGalleryLightbox();
  bootFromQueryId();
});

/* =============================
   Smooth open & music
============================= */
const music = document.getElementById("music");
function openInvitation(){
  document.getElementById("content").scrollIntoView({ behavior:"smooth" });
  playMusicSafe();
}
function playMusicSafe(){
  music.play().catch(()=>{});
}
function toggleMusic(){
  music.paused ? music.play().catch(()=>{}) : music.pause();
}

/* =============================
   Bottom sheet controls
============================= */
function openSheet(){ document.getElementById("sheet").classList.add("open"); }
function closeSheet(){ document.getElementById("sheet").classList.remove("open"); }

/* =============================
   Lightbox
============================= */
function initGalleryLightbox(){
  document.querySelectorAll("#gallery img").forEach(img=>{
    img.addEventListener("click", ()=>openLightbox(img.src));
  });
}
function openLightbox(src){
  lightbox.style.display = "flex";
  lightboxImg.src = src;
}
function closeLightbox(){
  lightbox.style.display = "none";
  lightboxImg.src = "";
}

/* =============================
   Scroll reveal
============================= */
function initReveal(){
  const els = document.querySelectorAll(".fade");
  const io = new IntersectionObserver((entries)=>{
    entries.forEach(e=>{
      if(e.isIntersecting) e.target.classList.add("show");
    });
  }, { threshold: 0.12 });
  els.forEach(el=>io.observe(el));
}

/* =============================
   Guestbook dummy (frontend)
============================= */
function initGuestbookDummy(){
  const form = document.getElementById("guestForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const name = guestName.value.trim();
    const msg = guestMsg.value.trim();
    const att = guestAttend.value;
    if(!name || !msg) return;

    const div = document.createElement("div");
    div.className = "gItem";
    div.innerHTML = `<strong>${escapeHtml(name)}</strong> <span style="color:#999">‚Ä¢ ${escapeHtml(att)}</span><br>${escapeHtml(msg)}`;
    guestPreview.prepend(div);

    // simple submit animation
    form.querySelector("button").innerHTML = "Terkirim ‚úÖ";
    setTimeout(()=>form.querySelector("button").innerHTML = `<i class="fa-solid fa-paper-plane"></i> Kirim`, 900);

    guestName.value = ""; guestMsg.value = ""; guestAttend.value = "Hadir";
  });
}
function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
}

/* =============================
   Photo compress helper
============================= */
async function fileToSmallDataURL(file, maxW=900, quality=0.78){
  const img = await new Promise((res, rej)=>{
    const i = new Image();
    i.onload = ()=>res(i);
    i.onerror = rej;
    i.src = URL.createObjectURL(file);
  });

  const scale = Math.min(1, maxW / img.width);
  const w = Math.round(img.width * scale);
  const h = Math.round(img.height * scale);

  const canvas = document.createElement("canvas");
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL("image/jpeg", quality);
}

/* =============================
   Map helpers (FIX)
============================= */
function mapToEmbed(queryOrUrl){
  const s = (queryOrUrl || "").trim();
  if (!s) return "https://www.google.com/maps?q=Indonesia&output=embed";
  return "https://www.google.com/maps?q=" + encodeURIComponent(s) + "&output=embed";
}
function mapToOpenUrl(queryOrUrl){
  const s = (queryOrUrl || "").trim() || "Indonesia";
  return "https://www.google.com/maps?q=" + encodeURIComponent(s);
}

/* =============================
   AI Generate (User input)
============================= */
async function generateAndPreview(){
  const userText = document.getElementById("prompt").value.trim();
  if(!userText) {
    sheetHint.textContent = "Isi prompt dulu ya üôÇ";
    return;
  }
  sheetHint.textContent = "‚è≥ Generate dari AI‚Ä¶";

  // music selected
  currentMusic = document.getElementById("musicSelect").value;
  document.getElementById("musicSource").src = currentMusic;
  music.load();

  // call worker /generate
  const res = await fetch(API + "/generate",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ text: userText })
  });
  const data = await res.json();
  if(!data.success){
    sheetHint.textContent = "‚ùå Generate gagal. Cek worker/secret.";
    return;
  }

  // apply overrides
  const inv = data.invite || {};
  const go = groomOverride.value.trim();
  const bo = brideOverride.value.trim();
  const dateO = dateOverride.value.trim();
  const akadO = akadOverride.value.trim();
  const resO = resepsiOverride.value.trim();
  const venueO = venueOverride.value.trim();
  const mapsO = mapsOverride.value.trim();

  if(go) inv.groom = go;
  if(bo) inv.bride = bo;
  if(dateO) inv.date = dateO;
  if(akadO) inv.akad_time = akadO.includes("Akad") ? akadO : `Akad: ${akadO}`;
  if(resO) inv.resepsi_time = resO.includes("Resepsi") ? resO : `Resepsi: ${resO}`;
  if(venueO) { inv.venue = venueO; if(!inv.address) inv.address = venueO; }
  if(mapsO) inv.maps_query = mapsO;

  // ensure maps_query exists
  inv.maps_query = inv.maps_query || inv.address || inv.venue || "Indonesia";

  // create full_text
  inv.full_text = inv.full_text || `${inv.title || "Undangan Pernikahan"}
Mempelai:
- ${inv.groom || "(Namamu)"}
- ${inv.bride || "(Nama Pasanganmu)"}

Tanggal: ${inv.date || "-"}
${inv.akad_time || "Akad: -"}
${inv.resepsi_time || "Resepsi: -"}

Lokasi: ${inv.venue || "-"}
Alamat: ${inv.address || "-"}

Cerita:
${inv.story || "-"}

${inv.closing || ""}`;

  currentInvite = inv;

  // apply to page UI
  applyInviteToUI(inv);

  sheetHint.textContent = "‚úÖ Berhasil! Undangan sudah terisi. Sekarang bisa Simpan & Buat Link.";
}

/* =============================
   Apply invite data to UI
============================= */
function applyInviteToUI(inv){
  const groom = inv.groom || "(Namamu)";
  const bride = inv.bride || "(Nama Pasanganmu)";
  const date = inv.date || "Tanggal Acara";

  heroNames.textContent = `${groom} & ${bride}`;
  heroDate.textContent = date;

  groomName.textContent = groom;
  brideName.textContent = bride;
  footerNames.textContent = `${groom} & ${bride}`;

  akadInfo.textContent = `${date}\n${inv.akad_time || "Akad: -"}\n${inv.venue || "-"}`;
  resepsiInfo.textContent = `${date}\n${inv.resepsi_time || "Resepsi: -"}\n${inv.venue || "-"}`;

  // map
  locText.textContent = "üìç " + (inv.maps_query || inv.venue || "Indonesia");
  map.src = mapToEmbed(inv.maps_query || inv.venue);
  openMapsBtn.href = mapToOpenUrl(inv.maps_query || inv.venue);

  // countdown
  startCountdownFromDate(inv.date);

  // auto scroll preview
  document.getElementById("content").scrollIntoView({ behavior:"smooth" });
}

/* =============================
   Countdown (best-effort)
   - coba parse "20 Juli 2026"
============================= */
let countdownTimer = null;
function parseIndoDate(dateStr){
  if(!dateStr) return null;
  // try native Date first
  const d1 = new Date(dateStr);
  if(!isNaN(d1.getTime())) return d1;

  const m = {
    januari:0,februari:1,maret:2,april:3,mei:4,juni:5,
    juli:6,agustus:7,september:8,oktober:9,november:10,desember:11
  };
  const s = dateStr.toLowerCase().trim();
  const parts = s.split(/\s+/); // ex: 20 juli 2026
  if(parts.length >= 3){
    const day = parseInt(parts[0],10);
    const mon = m[parts[1]];
    const yr  = parseInt(parts[2],10);
    if(!isNaN(day) && mon !== undefined && !isNaN(yr)){
      return new Date(yr, mon, day, 8, 0, 0); // default 08:00
    }
  }
  return null;
}
function startCountdownFromDate(dateStr){
  const dt = parseIndoDate(dateStr);
  if(!dt){
    countHint.textContent = "*Countdown belum bisa baca tanggal otomatis. Isi tanggal format: 20 Juli 2026";
    return;
  }
  countHint.textContent = "*Countdown aktif.";
  const target = dt.getTime();

  if(countdownTimer) clearInterval(countdownTimer);
  countdownTimer = setInterval(()=>{
    const diff = target - Date.now();
    if(diff <= 0) return;
    d.textContent = Math.floor(diff/86400000);
    h.textContent = Math.floor(diff/3600000)%24;
    m.textContent = Math.floor(diff/60000)%60;
    s.textContent = Math.floor(diff/1000)%60;
  }, 1000);
}

/* =============================
   Copy preview text (full_text)
============================= */
async function copyPreviewText(){
  if(!currentInvite?.full_text){
    sheetHint.textContent = "Belum ada hasil AI untuk dicopy.";
    return;
  }
  await navigator.clipboard.writeText(currentInvite.full_text);
  toastShow("Teks disalin ‚úÖ");
}

/* =============================
   (1) SAVE TO KV + MAKE SHARE LINK
   - includes: invite + music + photos
============================= */
async function saveToKVAndMakeLink(){
  if(!currentInvite){
    sheetHint.textContent = "Generate dulu sebelum simpan.";
    return;
  }
  sheetHint.textContent = "‚è≥ Menyimpan undangan‚Ä¶";

  // photos
  const photos = {};
  try{
    const gFile = groomPhoto.files[0];
    const bFile = bridePhoto.files[0];
    const galFiles = [...galleryPhotos.files].slice(0,10);

    if(gFile) photos.groom = await fileToSmallDataURL(gFile, 900, 0.78);
    if(bFile) photos.bride = await fileToSmallDataURL(bFile, 900, 0.78);

    if(galFiles.length){
      photos.gallery = [];
      for(const f of galFiles){
        photos.gallery.push(await fileToSmallDataURL(f, 1100, 0.75));
      }
    }
  } catch(e){
    // if compress fails, ignore
  }

  // push photos to UI immediately
  if(photos.groom) groomImg.src = photos.groom;
  if(photos.bride) brideImg.src = photos.bride;
  if(photos.gallery?.length){
    gallery.innerHTML = "";
    photos.gallery.forEach(src=>{
      const img = document.createElement("img");
      img.src = src;
      img.addEventListener("click", ()=>openLightbox(src));
      gallery.appendChild(img);
    });
  }

  // payload
  const payload = {
    invite: currentInvite,
    aiText: currentInvite.full_text,
    music: currentMusic,
    photos
  };

  const res = await fetch(API + "/invite/save", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  const data = await res.json();

  if(!data.success){
    sheetHint.textContent = "‚ùå Gagal menyimpan. Cek KV bind INVITES.";
    return;
  }

  const shareUrl = location.origin + location.pathname + "?id=" + data.id;
  await navigator.clipboard.writeText(shareUrl);

  sheetHint.textContent = "‚úÖ Tersimpan! Link sudah dicopy.";
  toastShow("Link undangan disalin ‚úÖ");

  // close sheet
  closeSheet();
}

/* =============================
   Boot from share link: ?id=
   (1) GET /invite/get?id=...
============================= */
async function bootFromQueryId(){
  const q = new URLSearchParams(location.search);
  const id = q.get("id");
  if(!id) return;

  // hide sheet (in case)
  closeSheet();

  // fetch from worker
  const res = await fetch(API + "/invite/get?id=" + encodeURIComponent(id));
  if(!res.ok) return;
  const data = await res.json();

  // apply
  currentInvite = data.invite || null;
  currentMusic = data.music || "wedding1.mp3";

  document.getElementById("musicSource").src = currentMusic;
  music.load();

  if(currentInvite) applyInviteToUI(currentInvite);

  // photos
  const photos = data.photos || {};
  if(photos.groom) groomImg.src = photos.groom;
  if(photos.bride) brideImg.src = photos.bride;

  if(photos.gallery?.length){
    gallery.innerHTML = "";
    photos.gallery.forEach(src=>{
      const img = document.createElement("img");
      img.src = src;
      img.addEventListener("click", ()=>openLightbox(src));
      gallery.appendChild(img);
    });
    // rebind lightbox
  } else {
    // rebind default images too
    initGalleryLightbox();
  }

  // show that it‚Äôs a published invite
  toastShow("Undangan dimuat dari link ‚úÖ");
}

/* =============================
   Share current link
============================= */
async function shareLink(){
  await navigator.clipboard.writeText(location.href);
  toastShow("Link disalin ‚úÖ");
}

/* =============================
   Toast
============================= */
function toastShow(text){
  toast.textContent = text;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none", 1600);
}
</script>
</body>
</html>
