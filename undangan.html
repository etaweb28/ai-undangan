<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Undangan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{margin:0;font-family:Segoe UI,Arial;background:#f7f4ef;color:#333}
    header{background:linear-gradient(135deg,#b11226,#7b0f1d);color:#fff;padding:44px 18px;text-align:center}
    section{max-width:900px;margin:auto;padding:22px 16px}
    .box{background:#fff;border-radius:16px;padding:18px;box-shadow:0 10px 28px rgba(0,0,0,.08)}
    h2{color:#b11226;text-align:center}
    iframe{width:100%;height:280px;border:0;border-radius:14px;margin-top:10px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    img.portrait{width:100%;border-radius:14px;object-fit:cover}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;margin-top:12px}
    .gallery img{width:100%;border-radius:12px}
    .music{position:fixed;bottom:18px;right:18px;background:#b11226;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-size:22px;box-shadow:0 10px 24px rgba(0,0,0,.25);cursor:pointer}
    input,textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;margin-top:10px}
    button{width:100%;padding:14px;border-radius:14px;border:none;background:#b11226;color:#fff;margin-top:10px}
    .guest{background:#fff;padding:12px;border-radius:12px;margin-top:10px;box-shadow:0 4px 12px rgba(0,0,0,.06)}
    .small{font-size:12px;color:#777;text-align:center;margin-top:10px}
  </style>
</head>
<body>

<header>
  <h1 id="coupleTitle">Undangan</h1>
  <p id="eventLine">Mohon doa restu</p>
</header>

<section>
  <h2>Foto Mempelai</h2>
  <div class="row">
    <div class="box"><img id="groomImg" class="portrait" alt="Foto (Namamu)"></div>
    <div class="box"><img id="brideImg" class="portrait" alt="Foto (Nama Pasanganmu)"></div>
  </div>

  <div class="box" style="margin-top:12px">
    <h2>Undangan</h2>
    <pre id="invitationText" style="white-space:pre-wrap;margin:0">‚è≥ Memuat‚Ä¶</pre>
  </div>

  <div class="box" style="margin-top:12px">
    <h2>Galeri</h2>
    <div id="gallery" class="gallery"></div>
  </div>
</section>

<section>
  <h2>Lokasi Acara</h2>
  <div class="box">
    <div id="locText"></div>
    <iframe id="map"></iframe>
    <button onclick="shareWA()">üì§ Share WhatsApp</button>
  </div>
  <div class="small">Tap layar sekali untuk mulai musik (aturan browser).</div>
</section>

<section>
  <h2>Ucapan & Doa</h2>
  <div class="box">
    <input id="guestName" placeholder="Nama kamu">
    <textarea id="guestMsg" placeholder="Tulis ucapan..." rows="3"></textarea>
    <button onclick="sendGuest()">üíå Kirim Ucapan</button>
    <div id="guestList"></div>
  </div>
</section>

<div class="music" onclick="toggleMusic()">üéµ</div>

<script>
const API = "https://dry-mud-3b8ai-undangan-api.etaweb90.workers.dev";
const params = new URLSearchParams(location.search);
const inviteId = params.get("id");

let audio = new Audio();
audio.loop = true;
document.addEventListener("click", () => audio.play().catch(()=>{}), { once:true });
function toggleMusic(){ audio.paused ? audio.play() : audio.pause(); }

function mapToEmbed(queryOrUrl){
  const s = (queryOrUrl || "").trim();
  if (!s) return "https://www.google.com/maps?q=Indonesia&output=embed";
  if (s.includes("google.com/maps") || s.includes("maps.app.goo.gl") || s.includes("maps.google")) {
    // aman: tetap pakai q=URL (embed universal)
    return "https://www.google.com/maps?q=" + encodeURIComponent(s) + "&output=embed";
  }
  return "https://www.google.com/maps?q=" + encodeURIComponent(s) + "&output=embed";
}

async function loadInvite(){
  if(!inviteId){
    document.getElementById("invitationText").textContent = "Link undangan tidak valid.";
    return;
  }
  const res = await fetch(API + "/invite/get?id=" + inviteId);
  const data = await res.json();

  const invite = data.invite || {};
  document.getElementById("invitationText").textContent = data.aiText || invite.full_text || "";
  document.getElementById("coupleTitle").textContent = `${invite.groom || "(Namamu)"} & ${invite.bride || "(Nama Pasanganmu)"}`;
  document.getElementById("eventLine").textContent = `${invite.date || ""} ‚Ä¢ ${invite.venue || ""}`;

  // musik
  if (data.music) audio.src = data.music;

  // maps
  const mapsQuery = invite.maps_query || invite.address || invite.venue || "";
  document.getElementById("locText").textContent = mapsQuery ? ("üìç " + mapsQuery) : "";
  document.getElementById("map").src = mapToEmbed(mapsQuery);

  // foto
  const photos = data.photos || {};
  document.getElementById("groomImg").src = photos.groom || "https://via.placeholder.com/600x600?text=Foto+(Namamu)";
  document.getElementById("brideImg").src = photos.bride || "https://via.placeholder.com/600x600?text=Foto+(Nama+Pasanganmu)";

  // galeri
  const g = document.getElementById("gallery");
  g.innerHTML = "";
  (photos.gallery || []).forEach(src => {
    const img = document.createElement("img");
    img.src = src;
    g.appendChild(img);
  });
}

function shareWA(){
  const text = encodeURIComponent("Assalamu‚Äôalaikum,\n\nKami mengundang Anda ke acara pernikahan kami.\n\n" + location.href);
  window.open("https://wa.me/?text=" + text, "_blank");
}

// guestbook
async function sendGuest(){
  const name = guestName.value.trim();
  const message = guestMsg.value.trim();
  if(!name || !message) return;

  await fetch(API + "/guestbook/add", {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ inviteId, name, message })
  });

  guestName.value = "";
  guestMsg.value = "";
  loadGuestbook();
}

async function loadGuestbook(){
  const res = await fetch(API + "/guestbook/list?id=" + inviteId);
  const list = await res.json();

  const box = document.getElementById("guestList");
  box.innerHTML = "";
  list.slice().reverse().forEach(item => {
    const div = document.createElement("div");
    div.className = "guest";
    div.innerHTML = `<strong>${item.name}</strong><br>${item.message}`;
    box.appendChild(div);
  });
}

loadInvite();
loadGuestbook();
</script>
</body>
</html>
